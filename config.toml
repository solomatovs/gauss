api_port = 9200
ws_buffer = 4096          # размер буфера подписок WS клиентов
ws_overflow = "drop"      # при переполнении WS канала: "drop" или "back_pressure"

# ═══════════════════════════════════════
#  Formats — именованные FormatSerializer'ы
# ═══════════════════════════════════════

[[formats]]
name = "json"
plugin = "/app/plugins/libcodec_json.so"

[[formats]]
name = "csv-quotes"
plugin = "/app/plugins/libcodec_csv.so"
[formats.config]
delimiter = ","
columns = ["bid", "ask", "symbol", "ts_ms"]

[[formats]]
name = "proto-quote"
plugin = "/app/plugins/libcodec_protobuf.so"
[formats.config]
descriptor_path = "/app/schemas/quote.desc"
message_type = "market.Quote"

[[formats]]
name = "avro-quote"
plugin = "/app/plugins/libcodec_avro.so"
[formats.config]
schema_path = "/app/schemas/quote.avsc"

# ═══════════════════════════════════════
#  Topics — именованные каналы с storage
# ═══════════════════════════════════════

# Сырые котировки (in-memory ring-buffer)
[[topics]]
name = "quotes.raw"
format = "json"
storage = "memory"
buffer = 8192
overflow = "back_pressure"

[topics.storage_config]
max_records = 100000

# OHLC свечи — один topic на таймфрейм, storage = file plugin
[[topics]]
name = "ohlc.1s"
format = "json"
storage = "/app/plugins/libstorage_file.so"
buffer = 4096
overflow = "back_pressure"

[topics.storage_config]
data_dir = "./data/ohlc/1s"

[[topics]]
name = "ohlc.5s"
format = "json"
storage = "/app/plugins/libstorage_file.so"
buffer = 4096
overflow = "back_pressure"

[topics.storage_config]
data_dir = "./data/ohlc/5s"

[[topics]]
name = "ohlc.15s"
format = "json"
storage = "/app/plugins/libstorage_file.so"
buffer = 4096
overflow = "back_pressure"

[topics.storage_config]
data_dir = "./data/ohlc/15s"

[[topics]]
name = "ohlc.30s"
format = "json"
storage = "/app/plugins/libstorage_file.so"
buffer = 4096
overflow = "back_pressure"

[topics.storage_config]
data_dir = "./data/ohlc/30s"

[[topics]]
name = "ohlc.1m"
format = "json"
storage = "/app/plugins/libstorage_file.so"
buffer = 4096
overflow = "back_pressure"

[topics.storage_config]
data_dir = "./data/ohlc/1m"

[[topics]]
name = "ohlc.5m"
format = "json"
storage = "/app/plugins/libstorage_file.so"
buffer = 4096
overflow = "back_pressure"

[topics.storage_config]
data_dir = "./data/ohlc/5m"

[[topics]]
name = "ohlc.15m"
format = "json"
storage = "/app/plugins/libstorage_file.so"
buffer = 4096
overflow = "back_pressure"

[topics.storage_config]
data_dir = "./data/ohlc/15m"

[[topics]]
name = "ohlc.30m"
format = "json"
storage = "/app/plugins/libstorage_file.so"
buffer = 4096
overflow = "back_pressure"

[topics.storage_config]
data_dir = "./data/ohlc/30m"

[[topics]]
name = "ohlc.1h"
format = "json"
storage = "/app/plugins/libstorage_file.so"
buffer = 4096
overflow = "back_pressure"

[topics.storage_config]
data_dir = "./data/ohlc/1h"

[[topics]]
name = "ohlc.4h"
format = "json"
storage = "/app/plugins/libstorage_file.so"
buffer = 4096
overflow = "back_pressure"

[topics.storage_config]
data_dir = "./data/ohlc/4h"

[[topics]]
name = "ohlc.1d"
format = "json"
storage = "/app/plugins/libstorage_file.so"
buffer = 4096
overflow = "back_pressure"

[topics.storage_config]
data_dir = "./data/ohlc/1d"

[[topics]]
name = "ohlc.1w"
format = "json"
storage = "/app/plugins/libstorage_file.so"
buffer = 4096
overflow = "back_pressure"

[topics.storage_config]
data_dir = "./data/ohlc/1w"

[[topics]]
name = "ohlc.1y"
format = "json"
storage = "/app/plugins/libstorage_file.so"
buffer = 4096
overflow = "back_pressure"

[topics.storage_config]
data_dir = "./data/ohlc/1y"

# ── Loopback topics: CSV, Protobuf, Avro ──

[[topics]]
name = "quotes.csv"
format = "csv-quotes"
storage = "memory"
buffer = 8192
overflow = "back_pressure"

[topics.storage_config]
max_records = 100000

[[topics]]
name = "quotes.proto"
format = "proto-quote"
storage = "memory"
buffer = 8192
overflow = "back_pressure"

[topics.storage_config]
max_records = 100000

[[topics]]
name = "quotes.avro"
format = "avro-quote"
storage = "memory"
buffer = 8192
overflow = "back_pressure"

[topics.storage_config]
max_records = 100000

# ClickHouse (раскомментировать для включения):
# [[topics]]
# name = "ohlc.1m.ch"
# format = "json"
# storage = "/app/plugins/libstorage_clickhouse.so"
# buffer = 4096
# overflow = "back_pressure"
#
# [topics.storage_config]
# host = "ch01"
# port = 8123
# user = "admin"
# password = "secret"
# database = "default"
# table = "topic_data"

# ═══════════════════════════════════════
#  Processors — trigger-based обработка
# ═══════════════════════════════════════

# OHLC aggregation: trigger on "quotes.raw", publishes to ohlc.* topics
[[processors]]
plugin = "/app/plugins/libstage_ohlc.so"
trigger = "quotes.raw"
[processors.config]
timeframes = ["1s", "5s", "15s", "30s", "1m", "5m", "15m", "30m", "1h", "4h", "1d", "1w", "1y"]

# Symbol filter (раскомментировать для включения):
# [[processors]]
# plugin = "/app/plugins/libstage_symbol_filter.so"
# trigger = "quotes.raw"
# [processors.config]
# symbols = ["EURUSD", "GBPUSD"]
# target_topic = "quotes.filtered"

# ═══════════════════════════════════════
#  Sources — входящие данные → topic
# ═══════════════════════════════════════

[[sources]]
name = "tcp-json"
topic = "quotes.raw"
transport = "/app/plugins/libtransport_tcp_server.so"
framing = "/app/plugins/libframing_lines.so"
codec = "/app/plugins/libcodec_json.so"
buffer = 8192
overflow = "back_pressure"
conn_buffer = 4
conn_overflow = "back_pressure"
[sources.transport_config]
port = 9100

# Source с middleware сжатия (раскомментировать для включения):
# [[sources]]
# name = "tcp-compressed"
# topic = "quotes.raw"
# transport = "/app/plugins/libtransport_tcp_server.so"
# framing = "/app/plugins/libframing_length_prefixed.so"
# codec = "/app/plugins/libcodec_json.so"
# buffer = 8192
# overflow = "back_pressure"
# conn_buffer = 4
# conn_overflow = "back_pressure"
# [sources.transport_config]
# port = 9102
# [[sources.middleware]]
# plugin = "/app/plugins/libmiddleware_compress.so"
# [sources.middleware.config]
# algorithm = "gzip"
# level = 6

# ── Loopback sources: decode CSV / Protobuf / Avro → topics ──

# CSV loopback source
[[sources]]
name = "csv-loopback"
topic = "quotes.csv"
transport = "/app/plugins/libtransport_tcp_client.so"
framing = "/app/plugins/libframing_lines.so"
codec = "/app/plugins/libcodec_csv.so"
[sources.transport_config]
host = "127.0.0.1"
port = 9301
[sources.codec_config]
key_column = "col2"
ts_column = "col3"

# Protobuf loopback source
[[sources]]
name = "proto-loopback"
topic = "quotes.proto"
transport = "/app/plugins/libtransport_tcp_client.so"
framing = "/app/plugins/libframing_length_prefixed.so"
codec = "/app/plugins/libcodec_protobuf.so"
[sources.transport_config]
host = "127.0.0.1"
port = 9302
[sources.codec_config]
descriptor_path = "/app/schemas/quote.desc"
message_type = "market.Quote"
key_field = "symbol"
ts_field = "ts_ms"

# Avro loopback source
[[sources]]
name = "avro-loopback"
topic = "quotes.avro"
transport = "/app/plugins/libtransport_tcp_client.so"
framing = "/app/plugins/libframing_length_prefixed.so"
codec = "/app/plugins/libcodec_avro.so"
[sources.transport_config]
host = "127.0.0.1"
port = 9303
[sources.codec_config]
schema_path = "/app/schemas/quote.avsc"
key_field = "symbol"
ts_field = "ts_ms"

# TCP + CSV пример (раскомментировать для включения):
# [[sources]]
# name = "tcp-csv"
# topic = "quotes.raw"
# transport = "/app/plugins/libtransport_tcp_server.so"
# framing = "/app/plugins/libframing_lines.so"
# codec = "/app/plugins/libcodec_csv.so"
# [sources.transport_config]
# port = 9101
# [sources.codec_config]
# delimiter = ","
# quoting = true
# header = "absent"

# ═══════════════════════════════════════
#  Sinks — вывод данных
# ═══════════════════════════════════════
#
# Два режима:
#   Pipeline sink: transport + framing + codec (симметрично с Source)
#   Plugin sink:   монолитный .so плагин
#

# Pipeline sink: TCP сервер, все подключившиеся клиенты получают котировки (fan-out)
[[sinks]]
name = "tcp-json-out"
topics = ["quotes.raw"]
transport = "/app/plugins/libtransport_tcp_server.so"
framing = "/app/plugins/libframing_lines.so"
codec = "/app/plugins/libcodec_json.so"
buffer = 8192
overflow = "drop"
[sinks.transport_config]
port = 9300

# ── Loopback sinks: encode quotes.raw → CSV / Protobuf / Avro ──

# CSV loopback sink
[[sinks]]
name = "csv-loopback"
topics = ["quotes.raw"]
transport = "/app/plugins/libtransport_tcp_server.so"
framing = "/app/plugins/libframing_lines.so"
codec = "/app/plugins/libcodec_csv.so"
buffer = 4096
overflow = "drop"
[sinks.transport_config]
port = 9301

# Protobuf loopback sink
[[sinks]]
name = "proto-loopback"
topics = ["quotes.raw"]
transport = "/app/plugins/libtransport_tcp_server.so"
framing = "/app/plugins/libframing_length_prefixed.so"
codec = "/app/plugins/libcodec_protobuf.so"
buffer = 4096
overflow = "drop"
[sinks.transport_config]
port = 9302
[sinks.codec_config]
descriptor_path = "/app/schemas/quote.desc"
message_type = "market.Quote"
key_field = "symbol"
ts_field = "ts_ms"

# Avro loopback sink
[[sinks]]
name = "avro-loopback"
topics = ["quotes.raw"]
transport = "/app/plugins/libtransport_tcp_server.so"
framing = "/app/plugins/libframing_length_prefixed.so"
codec = "/app/plugins/libcodec_avro.so"
buffer = 4096
overflow = "drop"
[sinks.transport_config]
port = 9303
[sinks.codec_config]
schema_path = "/app/schemas/quote.avsc"
key_field = "symbol"
ts_field = "ts_ms"

# Pipeline sink: TCP клиент, отправка OHLC 1m свечей на downstream сервер
# [[sinks]]
# name = "downstream-ohlc"
# topics = ["ohlc.1m"]
# transport = "/app/plugins/libtransport_tcp_client.so"
# framing = "/app/plugins/libframing_lines.so"
# codec = "/app/plugins/libcodec_json.so"
# buffer = 4096
# overflow = "drop"
# [sinks.transport_config]
# host = "downstream-server"
# port = 9100

# Plugin sink (монолитный):
# [[sinks]]
# name = "custom"
# plugin = "/app/plugins/libsink_custom.so"
# topics = ["quotes.raw"]
# buffer = 8192
# overflow = "drop"
# [sinks.config]
# host = "downstream-server"
# port = 9200
